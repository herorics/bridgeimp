<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Long Run Will Win</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif;
            background: #0a0e14;
            color: #c9d1d9;
            min-height: 100vh;
            padding: 15px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #161b22;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid #30363d;
        }
        
        h1 {
            text-align: center;
            font-size: 2.2em;
            background: linear-gradient(135deg, #f0b90b 0%, #f8d12f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .subtitle {
            text-align: center;
            color: #8b949e;
            margin-bottom: 30px;
            font-size: 1em;
            font-weight: 300;
        }
        
        .section {
            background: #1c2128;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #30363d;
        }
        
        .section-title {
            color: #f0b90b;
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 600;
            padding-bottom: 8px;
            border-bottom: 3px solid #f0b90b;
        }
        
        .subsection-title {
            color: #c9d1d9;
            margin: 15px 0 10px 0;
            font-size: 1.1em;
            font-weight: 600;
            padding: 8px 12px;
            background: #21262d;
            border-radius: 6px;
            border-left: 4px solid #f0b90b;
        }
        
        .payoff-tables-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .payoff-table-wrapper {
            background: #1c2128;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #30363d;
        }
        
        .payoff-table-title {
            font-size: 1.2em;
            font-weight: 700;
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 6px;
        }
        
        .paid-title {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .balance-title {
            background: linear-gradient(135deg, #f0b90b 0%, #f8d12f 100%);
            color: #0a0e14;
            font-weight: 700;
        }
        
        .payoff-card {
            background: #21262d;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #f0b90b;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            border: 1px solid #30363d;
        }
        
        .payoff-card:hover {
            transform: translateX(5px);
            background: #2d333b;
        }
        
        .payoff-card:last-child {
            margin-bottom: 0;
        }
        
        .player-info {
            flex: 1;
        }
        
        .player-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #f0b90b;
            margin-bottom: 5px;
        }
        
        .player-imp {
            font-size: 0.95em;
            color: #8b949e;
            font-weight: 500;
        }
        
        .recent-change {
            margin-top: 5px;
            padding: 4px 8px;
            background: rgba(240, 185, 11, 0.1);
            border-radius: 4px;
            font-size: 0.75em;
            display: inline-block;
        }
        
        .change-label {
            color: #8b949e;
            font-weight: 500;
        }
        
        .change-value {
            font-weight: 700;
            color: #f0b90b;
        }
        
        .change-value.positive-change {
            color: #3fb950;
        }
        
        .change-value.negative-change {
            color: #f85149;
        }
        
        .player-money {
            font-size: 1.8em;
            font-weight: 700;
            text-align: right;
        }
        
        .positive {
            color: #3fb950 !important;
        }
        
        .negative {
            color: #f85149 !important;
        }
        
        .control-group {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        label {
            display: inline-block;
            min-width: 140px;
            color: #c9d1d9;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        input, select, button, textarea {
            padding: 10px 14px;
            border-radius: 6px;
            border: 1px solid #30363d;
            background: #0d1117;
            color: #c9d1d9;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #f0b90b;
            box-shadow: 0 0 0 3px rgba(240, 185, 11, 0.1);
        }
        
        button {
            background: linear-gradient(135deg, #f0b90b 0%, #f8d12f 100%);
            color: #0a0e14;
            font-weight: 700;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(240, 185, 11, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .primary-btn {
            background: linear-gradient(135deg, #f0b90b 0%, #f8d12f 100%);
            font-size: 1.05em;
            padding: 12px 30px;
            width: 100%;
            margin-top: 10px;
            color: #0a0e14;
        }
        
        .primary-btn:hover {
            box-shadow: 0 5px 15px rgba(240, 185, 11, 0.4);
        }
        
        .secondary-btn {
            background: linear-gradient(135deg, #3fb950 0%, #2ea043 100%);
            padding: 8px 16px;
            font-size: 0.9em;
            margin-top: 5px;
            color: white;
        }
        
        .secondary-btn.disabled {
            background: linear-gradient(135deg, #f85149 0%, #da3633 100%);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: #1c2128;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        th, td {
            padding: 10px 6px;
            text-align: center;
            border-bottom: 1px solid #30363d;
            font-size: 0.8em;
        }
        
        th {
            background: linear-gradient(135deg, #21262d 0%, #2d333b 100%);
            color: #f0b90b;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7em;
            letter-spacing: 0.5px;
        }
        
        tr:hover {
            background: #21262d;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        .record-detail {
            font-size: 0.75em;
            color: #8b949e;
        }
        
        .activity-log {
            margin-top: 20px;
            background: #1c2128;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #30363d;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 8px 10px;
            margin-bottom: 5px;
            background: #21262d;
            border-radius: 6px;
            font-size: 0.85em;
            border-left: 3px solid #f0b90b;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .log-time {
            color: #8b949e;
            font-weight: 600;
            font-size: 0.85em;
        }
        
        .delete-btn {
            background: linear-gradient(135deg, #f85149 0%, #da3633 100%);
            color: #fff;
            padding: 5px 10px;
            font-size: 0.8em;
        }
        
        .delete-btn:hover {
            box-shadow: 0 3px 10px rgba(248, 81, 73, 0.4);
        }
        
        textarea {
            width: 100%;
            min-height: 60px;
            resize: vertical;
            font-family: inherit;
        }
        
        .handicap-info {
            background: rgba(63, 185, 80, 0.1);
            padding: 10px 14px;
            border-radius: 6px;
            margin-top: 8px;
            border-left: 4px solid #3fb950;
            font-size: 0.85em;
            color: #c9d1d9;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
            padding: 15px;
            background: #1c2128;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #30363d;
        }
        
        .payment-adjustment {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .payoff-tables-container {
                grid-template-columns: 1fr;
            }
            
            .payment-adjustment {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🏆 Long Run Will Win</h1>
        <p class="subtitle">橋牌 IMP 記錄系統 - Bridge IMP Recording System</p>
        
        <!-- Entry Record Section -->
        <div class="section">
            <h2 class="section-title">📝 新增記錄 New Entry</h2>
            <div class="control-group">
                <label>日期 Date：</label>
                <input type="date" id="gameDate">
            </div>
            <div class="control-group">
                <label>賽局類型 Game Type：</label>
                <select id="gameType" onchange="handleGameTypeChange()">
                    <option value="1V1">1V1</option>
                    <option value="Chow vs JW vs Choi">Chow vs JW vs Choi</option>
                    <option value="Chow vs JW vs Choi vs SL">Chow vs JW vs Choi vs SL</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Choi IMP：</label>
                <select id="scoreChoi"></select>
            </div>
            <div class="control-group">
                <label>Chow IMP：</label>
                <select id="scoreChow"></select>
            </div>
            <div class="control-group">
                <label>SL IMP：</label>
                <select id="scoreSL"></select>
            </div>
            <div class="control-group">
                <label>JW IMP：</label>
                <select id="scoreJW"></select>
            </div>
            
            <div class="control-group">
                <label>調整說明 Adjust：</label>
                <textarea id="adjust" placeholder="請輸入導致此調整的原因或事件說明（選填）"></textarea>
            </div>
            
            <div class="control-group">
                <label>每 IMP 價值 (HKD)：</label>
                <input type="number" id="pointValue" value="25" min="1">
            </div>
            
            <button onclick="addRecord()" class="primary-btn">➕ 新增記錄 Add Record</button>
        </div>
        
        <!-- Payoff Tables -->
        <div class="payoff-tables-container">
            <div class="payoff-table-wrapper">
                <div class="payoff-table-title balance-title">📊 淨餘額 NET BALANCE</div>
                <div class="payoff-card">
                    <div class="player-info">
                        <div class="player-name">Choi</div>
                        <div class="player-imp" id="choiBalanceIMP">540 IMP</div>
                        <div class="recent-change" id="choiRecentChange">
                            <span class="change-label">Last: </span>
                            <span class="change-value">--</span>
                        </div>
                    </div>
                    <div class="player-money positive" id="choiBalanceMoney">HKD 20,533</div>
                </div>
                <div class="payoff-card">
                    <div class="player-info">
                        <div class="player-name">Chow</div>
                        <div class="player-imp" id="chowBalanceIMP">-540 IMP</div>
                        <div class="recent-change" id="chowRecentChange">
                            <span class="change-label">Last: </span>
                            <span class="change-value">--</span>
                        </div>
                    </div>
                    <div class="player-money negative" id="chowBalanceMoney">HKD -20,826</div>
                </div>
                <div class="payoff-card">
                    <div class="player-info">
                        <div class="player-name">SL</div>
                        <div class="player-imp" id="slBalanceIMP">287.5 IMP</div>
                        <div class="recent-change" id="slRecentChange">
                            <span class="change-label">Last: </span>
                            <span class="change-value">--</span>
                        </div>
                    </div>
                    <div class="player-money negative" id="slBalanceMoney">HKD -5,194</div>
                </div>
                <div class="payoff-card">
                    <div class="player-info">
                        <div class="player-name">JW</div>
                        <div class="player-imp" id="jwBalanceIMP">-287.5 IMP</div>
                        <div class="recent-change" id="jwRecentChange">
                            <span class="change-label">Last: </span>
                            <span class="change-value">--</span>
                        </div>
                    </div>
                    <div class="player-money positive" id="jwBalanceMoney">HKD 5,486</div>
                </div>
            </div>
            
            <div class="payoff-table-wrapper">
                <div class="payoff-table-title paid-title">💰 已支付 PAID</div>
                <div class="payoff-card">
                    <div class="player-info">
                        <div class="player-name">Choi</div>
                        <div class="player-imp" id="choiPaidIMP">540 IMP</div>
                    </div>
                    <div class="player-money positive" id="choiPaidMoney">HKD 20,533</div>
                </div>
                <div class="payoff-card">
                    <div class="player-info">
                        <div class="player-name">Chow</div>
                        <div class="player-imp" id="chowPaidIMP">-540 IMP</div>
                    </div>
                    <div class="player-money negative" id="chowPaidMoney">HKD -20,826</div>
                </div>
                <div class="payoff-card">
                    <div class="player-info">
                        <div class="player-name">SL</div>
                        <div class="player-imp" id="slPaidIMP">287.5 IMP</div>
                    </div>
                    <div class="player-money negative" id="slPaidMoney">HKD -5,194</div>
                </div>
                <div class="payoff-card">
                    <div class="player-info">
                        <div class="player-name">JW</div>
                        <div class="player-imp" id="jwPaidIMP">-287.5 IMP</div>
                    </div>
                    <div class="player-money positive" id="jwPaidMoney">HKD 5,486</div>
                </div>
            </div>
        </div>
        
        <!-- Handicap Settings Section -->
        <div class="section">
            <h2 class="section-title">⚙️ 讓分設定 Handicap Settings</h2>
            
            <!-- Section 1: 1v1 Handicap -->
            <div class="subsection-title">Section 1: 1V1 Handicap (只應用於1V1賽局)</div>
            <div class="control-group">
                <label>啟用 Enable：</label>
                <button onclick="toggle1v1Handicap()" class="secondary-btn disabled" id="handicap1v1Btn">
                    ❌ 未啟用 Disabled
                </button>
            </div>
            <div id="handicap1v1Settings" style="display: none;">
                <div class="control-group">
                    <label>讓分玩家：</label>
                    <select id="handicap1v1From">
                        <option value="">無 None</option>
                        <option value="Choi">Choi</option>
                        <option value="Chow" selected>Chow</option>
                        <option value="SL">SL</option>
                        <option value="JW">JW</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>讓給：</label>
                    <select id="handicap1v1To">
                        <option value="">無 None</option>
                        <option value="Choi" selected>Choi</option>
                        <option value="Chow">Chow</option>
                        <option value="SL">SL</option>
                        <option value="JW">JW</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>讓分 IMP：</label>
                    <select id="handicap1v1Points"></select>
                </div>
            </div>
            
            <!-- Section 2: 3-Player Handicap -->
            <div class="subsection-title">Section 2: Chow vs JW vs Choi Handicap</div>
            <div class="control-group">
                <label>Choi 讓分給：</label>
                <button onclick="toggleChoi3PlayerHandicap()" class="secondary-btn disabled" id="choi3PlayerBtn">
                    ❌ 未啟用 Disabled
                </button>
            </div>
            <div class="control-group" id="choi3PlayerSettings" style="display: none;">
                <label>Choi 讓 Chow:</label>
                <select id="choiToChow" style="width: 120px;"></select>
                <span style="margin: 0 10px;">IMP</span>
                <label>Choi 讓 JW:</label>
                <select id="choiToJW" style="width: 120px;"></select>
                <span>IMP</span>
            </div>
            
            <div class="handicap-info">
                ✓ 讓分設定：所有新記錄將根據賽局類型自動應用相應讓分
            </div>
        </div>
        
        <!-- Balance History Chart -->
        <div class="section">
            <h2 class="section-title">📈 餘額歷史圖表 Balance History Chart</h2>
            <div class="chart-container">
                <canvas id="balanceChart"></canvas>
            </div>
        </div>
        
        <!-- Comparison Chart -->
        <div class="section">
            <h2 class="section-title">📊 四人比較圖 Player Comparison Chart</h2>
            <div class="chart-container" style="height: 300px;">
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>
        
        <!-- Records Table Section -->
        <div class="section">
            <h2 class="section-title">📊 賽局記錄 Game Records</h2>
            <div style="overflow-x: auto;">
                <table id="recordTable">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>類型</th>
                            <th>Choi<br>原始/讓分/總計<br>IMP / $</th>
                            <th>Chow<br>原始/讓分/總計<br>IMP / $</th>
                            <th>SL<br>原始/讓分/總計<br>IMP / $</th>
                            <th>JW<br>原始/讓分/總計<br>IMP / $</th>
                            <th>調整</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="recordBody">
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Payment Adjustment Section -->
        <div class="section">
            <h2 class="section-title">💵 支付調整 Payment Adjustment</h2>
            <p style="color: #8b949e; margin-bottom: 15px; font-size: 0.9em;">
                調整已支付金額 (例如: Chow 付款給 Choi HKD 10,000)
            </p>
            <div class="control-group">
                <label>付款人 From：</label>
                <select id="payFrom">
                    <option value="Choi">Choi</option>
                    <option value="Chow">Chow</option>
                    <option value="SL">SL</option>
                    <option value="JW">JW</option>
                </select>
            </div>
            <div class="control-group">
                <label>收款人 To：</label>
                <select id="payTo">
                    <option value="Choi">Choi</option>
                    <option value="Chow">Chow</option>
                    <option value="SL">SL</option>
                    <option value="JW">JW</option>
                </select>
            </div>
            <div class="control-group">
                <label>金額 Amount (HKD)：</label>
                <input type="number" id="payAmount" value="0" min="0" step="100">
            </div>
            <div class="control-group">
                <label>備註 Note：</label>
                <textarea id="payNote" placeholder="付款原因或備註"></textarea>
            </div>
            <button onclick="addPaymentAdjustment()" class="primary-btn">💰 記錄支付 Record Payment</button>
        </div>
        
        <!-- Activity Log Section -->
        <div class="activity-log">
            <h2 class="section-title">📋 活動日誌 Activity Log</h2>
            <div id="activityLog"></div>
        </div>
    </div>
    
    <script>
        // ===== FIREBASE CONFIGURATION =====
        // TODO: Replace with your Firebase project configuration
        const firebaseConfig = {
              apiKey: "AIzaSyC8xXxXxXxXxXxXxXxXxXxXxXxXxXxXxXx",
  authDomain: "bridge-imp-tracker.firebaseapp.com",
  databaseURL: "https://bridge-imp-tracker-default-rtdb.firebaseio.com",
  projectId: "bridge-imp-tracker",
  storageBucket: "bridge-imp-tracker.appspot.com",
  messagingSenderId: "123456789012",
  appId: "1:123456789012:web:abc123def456ghi789"
};
        
        // Initialize Firebase
        let database;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            alert('Firebase 配置錯誤，請檢查配置。數據將不會同步。\\nFirebase configuration error. Data will not sync.');
        }
        
        // ===== GLOBAL VARIABLES =====
        let records = [];
        let activityLog = [];
        let choi3PlayerHandicapEnabled = false;
        let handicap1v1Enabled = false;
        let balanceChart = null;
        let comparisonChart = null;
        
        const initialPayoff = {
            Choi: { imp: 540, money: 20533 },
            Chow: { imp: -540, money: -20826 },
            SL: { imp: 287.5, money: -5194 },
            JW: { imp: -287.5, money: 5486 }
        };
        
        // ===== HONG KONG TIME UTILITIES =====
        function getHongKongTime() {
            const now = new Date();
            // Convert to Hong Kong time (UTC+8)
            return new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' }));
        }
        
        function formatHKTime(date) {
            return new Date(date).toLocaleString('zh-TW', {
                timeZone: 'Asia/Hong_Kong',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }
        
        // ===== INITIALIZATION =====
        function initializeDropdowns() {
            // Initialize IMP dropdowns (-100 to +100, 1.0 increments)
            const impSelects = ['scoreChoi', 'scoreChow', 'scoreSL', 'scoreJW'];
            impSelects.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '';
                for (let i = -100; i <= 100; i += 1) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i >= 0 ? `+${i.toFixed(1)}` : i.toFixed(1);
                    if (i === 0) option.selected = true;
                    select.appendChild(option);
                }
            });
            
            // Initialize handicap dropdown (0 to 10, 0.5 increments)
            const handicapSelects = ['handicap1v1Points', 'choiToChow', 'choiToJW'];
            handicapSelects.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '';
                for (let i = 0; i <= 10; i += 0.5) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i.toFixed(1);
                    if (i === 1.5) option.selected = true;
                    select.appendChild(option);
                }
            });
        }
        
        // Set today's date
        document.getElementById('gameDate').valueAsDate = getHongKongTime();
        
        // ===== HANDICAP TOGGLE FUNCTIONS =====
        function toggle1v1Handicap() {
            handicap1v1Enabled = !handicap1v1Enabled;
            const btn = document.getElementById('handicap1v1Btn');
            const settings = document.getElementById('handicap1v1Settings');
            
            if (handicap1v1Enabled) {
                btn.textContent = '✅ 已啟用 Enabled';
                btn.classList.remove('disabled');
                settings.style.display = 'block';
            } else {
                btn.textContent = '❌ 未啟用 Disabled';
                btn.classList.add('disabled');
                settings.style.display = 'none';
            }
            
            saveHandicapSettings();
        }
        
        function toggleChoi3PlayerHandicap() {
            choi3PlayerHandicapEnabled = !choi3PlayerHandicapEnabled;
            const btn = document.getElementById('choi3PlayerBtn');
            const settings = document.getElementById('choi3PlayerSettings');
            
            if (choi3PlayerHandicapEnabled) {
                btn.textContent = '✅ 已啟用 Enabled';
                btn.classList.remove('disabled');
                settings.style.display = 'flex';
            } else {
                btn.textContent = '❌ 未啟用 Disabled';
                btn.classList.add('disabled');
                settings.style.display = 'none';
            }
            
            saveHandicapSettings();
        }
        
        function handleGameTypeChange() {
            const gameType = document.getElementById('gameType').value;
            if (gameType === '1V1' && !handicap1v1Enabled) {
                toggle1v1Handicap();
            }
        }
        
        // ===== FIREBASE SYNC FUNCTIONS =====
        function saveHandicapSettings() {
            if (!database) return;
            
            const settings = {
                handicap1v1Enabled,
                choi3PlayerHandicapEnabled,
                handicap1v1From: document.getElementById('handicap1v1From').value,
                handicap1v1To: document.getElementById('handicap1v1To').value,
                handicap1v1Points: parseFloat(document.getElementById('handicap1v1Points').value),
                choiToChow: parseFloat(document.getElementById('choiToChow').value),
                choiToJW: parseFloat(document.getElementById('choiToJW').value)
            };
            
            database.ref('handicapSettings').set(settings);
        }
        
        function loadHandicapSettings() {
            if (!database) return;
            
            database.ref('handicapSettings').once('value', (snapshot) => {
                const settings = snapshot.val();
                if (settings) {
                    handicap1v1Enabled = settings.handicap1v1Enabled || false;
                    choi3PlayerHandicapEnabled = settings.choi3PlayerHandicapEnabled || false;
                    
                    if (settings.handicap1v1From) document.getElementById('handicap1v1From').value = settings.handicap1v1From;
                    if (settings.handicap1v1To) document.getElementById('handicap1v1To').value = settings.handicap1v1To;
                    if (settings.handicap1v1Points) document.getElementById('handicap1v1Points').value = settings.handicap1v1Points;
                    if (settings.choiToChow) document.getElementById('choiToChow').value = settings.choiToChow;
                    if (settings.choiToJW) document.getElementById('choiToJW').value = settings.choiToJW;
                    
                    // Update UI
                    if (handicap1v1Enabled) {
                        document.getElementById('handicap1v1Btn').textContent = '✅ 已啟用 Enabled';
                        document.getElementById('handicap1v1Btn').classList.remove('disabled');
                        document.getElementById('handicap1v1Settings').style.display = 'block';
                    }
                    if (choi3PlayerHandicapEnabled) {
                        document.getElementById('choi3PlayerBtn').textContent = '✅ 已啟用 Enabled';
                        document.getElementById('choi3PlayerBtn').classList.remove('disabled');
                        document.getElementById('choi3PlayerSettings').style.display = 'flex';
                    }
                }
            });
        }
        
        function syncRecordsFromFirebase() {
            if (!database) return;
            
            database.ref('records').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    records = Object.values(data);
                    records.sort((a, b) => a.id - b.id);
                    updateTable();
                    updatePayoff();
                    updateCharts();
                }
            });
        }
        
        function syncInitialPayoffFromFirebase() {
            if (!database) return;
            
            database.ref('initialPayoff').once('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    Object.keys(initialPayoff).forEach(player => {
                        if (data[player]) {
                            initialPayoff[player] = data[player];
                        }
                    });
                    updatePayoff();
                    updateCharts();
                }
            });
        }
        
        function syncActivityLogFromFirebase() {
            if (!database) return;
            
            database.ref('activityLog').limitToLast(50).on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    activityLog = Object.values(data);
                    activityLog.sort((a, b) => b.timestamp - a.timestamp);
                    updateActivityLog();
                }
            });
        }
        
        // ===== ACTIVITY LOG =====
        function addLog(message) {
            const now = getHongKongTime();
            const timeStr = formatHKTime(now);
            const log = {
                time: timeStr,
                message: message,
                timestamp: now.getTime()
            };
            
            activityLog.unshift(log);
            updateActivityLog();
            
            if (database) {
                database.ref('activityLog').push(log);
            }
        }
        
        function updateActivityLog() {
            const logDiv = document.getElementById('activityLog');
            logDiv.innerHTML = activityLog.slice(0, 50).map(log => 
                `<div class="log-entry"><span class="log-time">[${log.time}]</span> ${log.message}</div>`
            ).join('');
        }
        
        // ===== RECORD MANAGEMENT =====
        function addRecord() {
            const date = document.getElementById('gameDate').value;
            const gameType = document.getElementById('gameType').value;
            let scoreChoi = parseFloat(document.getElementById('scoreChoi').value) || 0;
            let scoreChow = parseFloat(document.getElementById('scoreChow').value) || 0;
            let scoreSL = parseFloat(document.getElementById('scoreSL').value) || 0;
            let scoreJW = parseFloat(document.getElementById('scoreJW').value) || 0;
            const adjust = document.getElementById('adjust').value;
            const pointValue = parseFloat(document.getElementById('pointValue').value) || 25;
            
            // Store original scores
            const originalScores = {
                Choi: scoreChoi,
                Chow: scoreChow,
                SL: scoreSL,
                JW: scoreJW
            };
            
            const handicaps = {
                Choi: 0,
                Chow: 0,
                SL: 0,
                JW: 0
            };
            
            let handicapInfo = '';
            
            // Apply handicap based on game type - FIXED: Only affect involved players
            if (gameType === '1V1' && handicap1v1Enabled) {
                const handicapFrom = document.getElementById('handicap1v1From').value;
                const handicapTo = document.getElementById('handicap1v1To').value;
                const handicapPoints = parseFloat(document.getElementById('handicap1v1Points').value) || 0;
                
                if (handicapFrom && handicapTo && handicapPoints > 0) {
                    handicapInfo = `1V1讓分: ${handicapFrom} → ${handicapTo} ${handicapPoints} IMP`;
                    // Only apply to the two players involved
                    if (handicapFrom in handicaps) {
                        handicaps[handicapFrom] = -handicapPoints;
                    }
                    if (handicapTo in handicaps) {
                        handicaps[handicapTo] = handicapPoints;
                    }
                }
            } else if (gameType === 'Chow vs JW vs Choi' && choi3PlayerHandicapEnabled) {
                const choiToChow = parseFloat(document.getElementById('choiToChow').value) || 0;
                const choiToJW = parseFloat(document.getElementById('choiToJW').value) || 0;
                
                if (choiToChow > 0 || choiToJW > 0) {
                    handicapInfo = `3人讓分: Choi → Chow ${choiToChow}, Choi → JW ${choiToJW} IMP`;
                    // Only apply to the three players involved (Choi, Chow, JW)
                    handicaps.Choi = -(choiToChow + choiToJW);
                    handicaps.Chow = choiToChow;
                    handicaps.JW = choiToJW;
                    // SL remains 0
                }
            }
            
            // Apply handicaps to scores
            scoreChoi += handicaps.Choi;
            scoreChow += handicaps.Chow;
            scoreSL += handicaps.SL;
            scoreJW += handicaps.JW;
            
            const record = {
                id: Date.now(),
                date: date,
                gameType: gameType,
                originalScores: originalScores,
                handicaps: handicaps,
                finalScores: {
                    Choi: scoreChoi,
                    Chow: scoreChow,
                    SL: scoreSL,
                    JW: scoreJW
                },
                adjust: adjust,
                handicap: handicapInfo,
                pointValue: pointValue,
                timestamp: getHongKongTime().getTime()
            };
            
            records.push(record);
            
            // Save to Firebase
            if (database) {
                database.ref('records/' + record.id).set(record);
            }
            
            addLog(`新增記錄：${date} ${gameType} - Choi: ${scoreChoi}, Chow: ${scoreChow}, SL: ${scoreSL}, JW: ${scoreJW}${handicapInfo ? ' (' + handicapInfo + ')' : ''}`);
            
            updateTable();
            updatePayoff();
            updateCharts();
            
            // Reset form
            document.getElementById('scoreChoi').value = 0;
            document.getElementById('scoreChow').value = 0;
            document.getElementById('scoreSL').value = 0;
            document.getElementById('scoreJW').value = 0;
            document.getElementById('adjust').value = '';
        }
        
        function addPaymentAdjustment() {
            const from = document.getElementById('payFrom').value;
            const to = document.getElementById('payTo').value;
            const amount = parseFloat(document.getElementById('payAmount').value) || 0;
            const note = document.getElementById('payNote').value;
            
            if (from === to) {
                alert('付款人和收款人不能相同！');
                return;
            }
            
            if (amount <= 0) {
                alert('金額必須大於0！');
                return;
            }
            
            // Convert payment to IMP equivalent at default rate
            const impEquivalent = amount / 25;
            
            // Adjust initial payoff
            initialPayoff[from].money -= amount;
            initialPayoff[from].imp -= impEquivalent;
            initialPayoff[to].money += amount;
            initialPayoff[to].imp += impEquivalent;
            
            // Save to Firebase
            if (database) {
                database.ref('initialPayoff').set(initialPayoff);
            }
            
            addLog(`💵 支付記錄：${from} 付款給 ${to} HKD ${amount.toLocaleString('zh-TW')}${note ? ' - ' + note : ''}`);
            
            updatePayoff();
            updateCharts();
            
            document.getElementById('payAmount').value = 0;
            document.getElementById('payNote').value = '';
        }
        
        function deleteRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;
            
            // Check if record is older than 24 hours
            const now = getHongKongTime().getTime();
            const recordTime = record.timestamp || record.id; // Use timestamp if available, else use id
            const hoursDiff = (now - recordTime) / (1000 * 60 * 60);
            
            if (hoursDiff > 24) {
                alert('此記錄已超過24小時，無法刪除！\\nThis record is older than 24 hours and cannot be deleted!');
                return;
            }
            
            if (!confirm('確定要刪除此記錄嗎？\\nAre you sure you want to delete this record?')) {
                return;
            }
            
            addLog(`刪除記錄：${record.date} ${record.gameType}`);
            
            records = records.filter(r => r.id !== id);
            
            // Delete from Firebase
            if (database) {
                database.ref('records/' + id).remove();
            }
            
            updateTable();
            updatePayoff();
            updateCharts();
        }
        
        // ===== UI UPDATE FUNCTIONS =====
        function updateTable() {
            const tbody = document.getElementById('recordBody');
            tbody.innerHTML = records.slice().reverse().map(record => {
                const formatPlayerData = (player) => {
                    const orig = record.originalScores[player];
                    const hcap = record.handicaps[player];
                    const final = record.finalScores[player];
                    const origMoney = (orig * record.pointValue).toFixed(0);
                    const hcapMoney = (hcap * record.pointValue).toFixed(0);
                    const finalMoney = (final * record.pointValue).toFixed(0);
                    
                    const hcapSign = hcap >= 0 ? '+' : '';
                    return `
                        <div class="record-detail">原: ${orig} / $${origMoney}</div>
                        <div class="record-detail">讓: ${hcapSign}${hcap} / $${hcapSign}${hcapMoney}</div>
                        <div style="font-weight: 700;">總: ${final} / $${finalMoney}</div>
                    `;
                };
                
                // Check if record can be deleted (within 24 hours)
                const now = getHongKongTime().getTime();
                const recordTime = record.timestamp || record.id;
                const canDelete = (now - recordTime) / (1000 * 60 * 60) <= 24;
                const deleteBtn = canDelete 
                    ? `<button class="delete-btn" onclick="deleteRecord(${record.id})">刪除</button>`
                    : `<button class="delete-btn" disabled style="opacity: 0.3;">已鎖定</button>`;
                
                return `
                    <tr>
                        <td>${record.date}</td>
                        <td>${record.gameType}</td>
                        <td>${formatPlayerData('Choi')}</td>
                        <td>${formatPlayerData('Chow')}</td>
                        <td>${formatPlayerData('SL')}</td>
                        <td>${formatPlayerData('JW')}</td>
                        <td>${record.adjust || '-'}</td>
                        <td>${deleteBtn}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function updatePayoff() {
            const totals = {
                Choi: { imp: initialPayoff.Choi.imp, money: initialPayoff.Choi.money },
                Chow: { imp: initialPayoff.Chow.imp, money: initialPayoff.Chow.money },
                SL: { imp: initialPayoff.SL.imp, money: initialPayoff.SL.money },
                JW: { imp: initialPayoff.JW.imp, money: initialPayoff.JW.money }
            };
            
            records.forEach(record => {
                Object.keys(totals).forEach(player => {
                    totals[player].imp += record.finalScores[player];
                    totals[player].money += record.finalScores[player] * record.pointValue;
                });
            });
            
            // Update PAID display
            Object.keys(initialPayoff).forEach(player => {
                const lowerPlayer = player.toLowerCase();
                const paidImpEl = document.getElementById(lowerPlayer + 'PaidIMP');
                const paidMoneyEl = document.getElementById(lowerPlayer + 'PaidMoney');
                
                paidImpEl.textContent = `${initialPayoff[player].imp.toFixed(1)} IMP`;
                paidMoneyEl.textContent = `HKD ${initialPayoff[player].money.toLocaleString('zh-TW')}`;
                paidMoneyEl.className = 'player-money ' + (initialPayoff[player].money >= 0 ? 'positive' : 'negative');
            });
            
            // Update NET BALANCE display
            Object.keys(totals).forEach(player => {
                const lowerPlayer = player.toLowerCase();
                const balanceImpEl = document.getElementById(lowerPlayer + 'BalanceIMP');
                const balanceMoneyEl = document.getElementById(lowerPlayer + 'BalanceMoney');
                const recentChangeEl = document.getElementById(lowerPlayer + 'RecentChange');
                
                balanceImpEl.textContent = `${totals[player].imp.toFixed(1)} IMP`;
                balanceMoneyEl.textContent = `HKD ${totals[player].money.toLocaleString('zh-TW')}`;
                balanceMoneyEl.className = 'player-money ' + (totals[player].money >= 0 ? 'positive' : 'negative');
                
                if (records.length > 0) {
                    const lastRecord = records[records.length - 1];
                    const lastChange = lastRecord.finalScores[player];
                    const lastChangeMoney = lastChange * lastRecord.pointValue;
                    const changeSign = lastChange >= 0 ? '+' : '';
                    const changeClass = lastChange > 0 ? 'positive-change' : lastChange < 0 ? 'negative-change' : '';
                    
                    const now = getHongKongTime();
                    const lastTime = new Date(lastRecord.timestamp || lastRecord.id);
                    const timeDiff = Math.floor((now - lastTime) / 1000 / 60);
                    const timeStr = timeDiff < 1 ? 'just now' : timeDiff < 60 ? `${timeDiff}m ago` : `${Math.floor(timeDiff / 60)}h ago`;
                    
                    recentChangeEl.innerHTML = `
                        <span class="change-label">Last: </span>
                        <span class="change-value ${changeClass}">${changeSign}${lastChange} IMP ($${changeSign}${lastChangeMoney.toFixed(0)})</span>
                        <span class="change-label"> · ${timeStr}</span>
                    `;
                } else {
                    recentChangeEl.innerHTML = `
                        <span class="change-label">Last: </span>
                        <span class="change-value">--</span>
                    `;
                }
            });
        }
        
        function updateCharts() {
            updateBalanceChart();
            updateComparisonChart();
        }
        
        function updateBalanceChart() {
            const ctx = document.getElementById('balanceChart');
            
            // Calculate cumulative balances over time
            const dates = ['Initial', ...records.map(r => r.date)];
            const players = ['Choi', 'Chow', 'SL', 'JW'];
            const colors = {
                Choi: '#f0b90b',
                Chow: '#f85149',
                SL: '#3fb950',
                JW: '#f8d12f'
            };
            
            const datasets = players.map(player => {
                const data = [initialPayoff[player].money];
                let cumulative = initialPayoff[player].money;
                
                records.forEach(record => {
                    cumulative += record.finalScores[player] * record.pointValue;
                    data.push(cumulative);
                });
                
                return {
                    label: player,
                    data: data,
                    borderColor: colors[player],
                    backgroundColor: colors[player] + '20',
                    tension: 0.3,
                    fill: false
                };
            });
            
            if (balanceChart) {
                balanceChart.destroy();
            }
            
            balanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Balance Over Time (HKD)',
                            color: '#f0b90b'
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#c9d1d9'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return 'HKD ' + value.toLocaleString();
                                },
                                color: '#8b949e'
                            },
                            grid: {
                                color: '#30363d'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#8b949e'
                            },
                            grid: {
                                color: '#30363d'
                            }
                        }
                    }
                }
            });
        }
        
        function updateComparisonChart() {
            const ctx = document.getElementById('comparisonChart');
            
            const totals = {
                Choi: initialPayoff.Choi.money,
                Chow: initialPayoff.Chow.money,
                SL: initialPayoff.SL.money,
                JW: initialPayoff.JW.money
            };
            
            records.forEach(record => {
                Object.keys(totals).forEach(player => {
                    totals[player] += record.finalScores[player] * record.pointValue;
                });
            });
            
            if (comparisonChart) {
                comparisonChart.destroy();
            }
            
            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Choi', 'Chow', 'SL', 'JW'],
                    datasets: [{
                        label: 'Current Balance (HKD)',
                        data: [totals.Choi, totals.Chow, totals.SL, totals.JW],
                        backgroundColor: [
                            'rgba(240, 185, 11, 0.7)',
                            'rgba(248, 81, 73, 0.7)',
                            'rgba(63, 185, 80, 0.7)',
                            'rgba(248, 209, 47, 0.7)'
                        ],
                        borderColor: [
                            '#f0b90b',
                            '#f85149',
                            '#3fb950',
                            '#f8d12f'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Player Comparison - Current Balance',
                            color: '#f0b90b'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return 'HKD ' + value.toLocaleString();
                                },
                                color: '#8b949e'
                            },
                            grid: {
                                color: '#30363d'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#8b949e'
                            },
                            grid: {
                                color: '#30363d'
                            }
                        }
                    }
                }
            });
        }
        
        // ===== INITIALIZE ON LOAD =====
        window.addEventListener('load', () => {
            initializeDropdowns();
            loadHandicapSettings();
            syncInitialPayoffFromFirebase();
            syncRecordsFromFirebase();
            syncActivityLogFromFirebase();
            updateActivityLog();
            addLog('系統啟動 - System Started');
            addLog('初始資料已載入 - Initial data loaded');
            updatePayoff();
            updateCharts();
        });
    </script>
</body>
</html>
