<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Long Run Will Win</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", "ÂæÆËªüÊ≠£ÈªëÈ´î", Arial, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 15px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #1a1a1a;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid #2a2a2a;
        }
        
        h1 {
            text-align: center;
            font-size: 2.5em;
            color: #ff9800;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 1em;
            font-weight: 300;
        }
        
        .section {
            background: #242424;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        
        .section-title {
            color: #ff9800;
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 600;
            padding-bottom: 8px;
            border-bottom: 2px solid #ff9800;
        }
        
        .subsection-title {
            color: #ffa726;
            margin: 15px 0 10px 0;
            font-size: 1.1em;
            font-weight: 600;
            padding: 8px 12px;
            background: #2a2a2a;
            border-radius: 6px;
            border-left: 4px solid #ff9800;
        }
        
        .payoff-tables-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .payoff-table-wrapper {
            background: #242424;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
        }
        
        .payoff-table-title {
            font-size: 1.2em;
            font-weight: 700;
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 6px;
            background: #ff9800;
            color: #000;
        }
        
        .paid-title {
            background: #ff9800;
            color: #000;
        }
        
        .balance-title {
            background: #ffa726;
            color: #000;
        }
        
        .payoff-card {
            background: #2a2a2a;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #ff9800;
            transition: transform 0.2s;
        }
        
        .payoff-card:hover {
            transform: translateX(5px);
            background: #333;
        }
        
        .player-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #ff9800;
            margin-bottom: 5px;
        }
        
        .player-imp {
            font-size: 0.95em;
            color: #aaa;
            font-weight: 500;
        }
        
        .recent-change {
            margin-top: 5px;
            padding: 4px 8px;
            background: rgba(255, 152, 0, 0.1);
            border-radius: 4px;
            font-size: 0.75em;
            display: inline-block;
        }
        
        .player-money {
            font-size: 1.8em;
            font-weight: 700;
            text-align: right;
        }
        
        .positive {
            color: #4caf50 !important;
        }
        
        .negative {
            color: #f44336 !important;
        }
        
        .control-group {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        label {
            display: inline-block;
            min-width: 140px;
            color: #ccc;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        input, select, button, textarea {
            padding: 10px 14px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #2a2a2a;
            color: #e0e0e0;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #ff9800;
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.2);
        }
        
        button {
            background: #ff9800;
            color: #000;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #ffa726;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
            transform: none;
        }
        
        .primary-btn {
            background: #ff9800;
            font-size: 1.05em;
            padding: 12px 30px;
            width: 100%;
            margin-top: 10px;
        }
        
        .primary-btn:hover {
            background: #ffa726;
        }

        .secondary-btn {
            background: #666;
            padding: 8px 16px;
            font-size: 0.9em;
            margin-top: 5px;
            color: #fff;
        }

        .secondary-btn.active {
            background: #ff9800;
            color: #000;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
        }
        
        th, td {
            padding: 10px 6px;
            text-align: center;
            border-bottom: 1px solid #333;
            font-size: 0.8em;
        }
        
        th {
            background: #1a1a1a;
            color: #ff9800;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7em;
            letter-spacing: 0.5px;
        }
        
        tr:hover {
            background: #333;
        }

        .record-detail {
            font-size: 0.75em;
            color: #aaa;
        }
        
        .activity-log {
            margin-top: 20px;
            background: #242424;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #333;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 8px 10px;
            margin-bottom: 5px;
            background: #2a2a2a;
            border-radius: 6px;
            font-size: 0.85em;
            border-left: 3px solid #ff9800;
        }
        
        .log-time {
            color: #888;
            font-weight: 600;
            font-size: 0.85em;
        }
        
        .delete-btn {
            background: #f44336;
            color: #fff;
            padding: 5px 10px;
            font-size: 0.8em;
        }
        
        .delete-btn:hover {
            background: #e53935;
        }

        .delete-btn:disabled {
            background: #555;
            color: #888;
        }
        
        textarea {
            width: 100%;
            min-height: 60px;
            resize: vertical;
            font-family: inherit;
        }
        
        .handicap-info {
            background: rgba(255, 152, 0, 0.1);
            padding: 10px 14px;
            border-radius: 6px;
            margin-top: 8px;
            border-left: 4px solid #ff9800;
            font-size: 0.85em;
            color: #ccc;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
            padding: 15px;
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .error-message {
            background: #f44336;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .success-message {
            background: #4caf50;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .score-sum {
            font-weight: 700;
            margin-left: 15px;
            padding: 5px 10px;
            border-radius: 4px;
            background: #333;
        }

        .score-sum.valid {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .score-sum.invalid {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .payoff-tables-container {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÜ LONG RUN WILL WIN</h1>
        <p class="subtitle">Ê©ãÁâå IMP Ë®òÈåÑÁ≥ªÁµ± - Bridge IMP Recording System</p>
        
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        
        <!-- Entry Record Section -->
        <div class="section">
            <h2 class="section-title">üìù Êñ∞Â¢ûË®òÈåÑ NEW ENTRY</h2>
            <div class="control-group">
                <label>Êó•Êúü DateÔºö</label>
                <input type="date" id="gameDate">
            </div>
            <div class="control-group">
                <label>Ë≥ΩÂ±ÄÈ°ûÂûã Game TypeÔºö</label>
                <select id="gameType" onchange="handleGameTypeChange()">
                    <option value="1V1">1V1</option>
                    <option value="Chow vs JW vs Choi">Chow vs JW vs Choi</option>
                    <option value="Chow vs JW vs Choi vs SL">Chow vs JW vs Choi vs SL</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Choi IMPÔºö</label>
                <select id="scoreChoi"></select>
                <span class="score-sum" id="scoreSum">Sum: 0</span>
            </div>
            <div class="control-group">
                <label>Chow IMPÔºö</label>
                <select id="scoreChow"></select>
            </div>
            <div class="control-group">
                <label>SL IMPÔºö</label>
                <select id="scoreSL"></select>
            </div>
            <div class="control-group">
                <label>JW IMPÔºö</label>
                <select id="scoreJW"></select>
            </div>
            
            <div class="control-group">
                <label>Ë™øÊï¥Ë™™Êòé AdjustÔºö</label>
                <textarea id="adjust" placeholder="Ë´ãËº∏ÂÖ•Â∞éËá¥Ê≠§Ë™øÊï¥ÁöÑÂéüÂõ†Êàñ‰∫ã‰ª∂Ë™™ÊòéÔºàÈÅ∏Â°´Ôºâ"></textarea>
            </div>
            
            <div class="control-group">
                <label>ÊØè IMP ÂÉπÂÄº (HKD)Ôºö</label>
                <input type="number" id="pointValue" value="25" min="1">
            </div>
            
            <button onclick="addRecord()" class="primary-btn" id="addRecordBtn">‚ûï Êñ∞Â¢ûË®òÈåÑ ADD RECORD</button>
        </div>
        
        <!-- Payoff Tables -->
        <div class="payoff-tables-container">
            <div class="payoff-table-wrapper">
                <div class="payoff-table-title balance-title">üìä Ê∑®È§òÈ°ç NET BALANCE</div>
                <div class="payoff-card">
                    <div class="player-info">
                        <div class="player-name">CHOI</div>
                        <div class="player-imp" id="choiBalanceIMP">540 IMP</div>
                        <div class="recent-change" id="choiRecentChange">
                            <span class="change-label">Last: </span>
                            <span class="change-value">--</span>
                        </div>
                    </div>
                    <div class="player-money positive" id="choiBalanceMoney">HKD 20,533</div>
                </div>
                <div class="payoff-card">
                    <div class="player-info">
                        <div class="player-name">CHOW</div>
                        <div class="player-imp" id="chowBalanceIMP">-540 IMP</div>
                        <div class="recent-change" id="chowRecentChange">
                            <span class="change-label">Last: </span>
                            <span class="change-value">--</span>
                        </div>
                    </div>
                    <div class="player-money negative" id="chowBalanceMoney">HKD -20,826</div>
                </div>
                <div class="payoff-card">
                    <div class="player-info">
                        <div class="player-name">SL</div>
                        <div class="player-imp" id="slBalanceIMP">287.5 IMP</div>
                        <div class="recent-change" id="slRecentChange">
                            <span class="change-label">Last: </span>
                            <span class="change-value">--</span>
                        </div>
                    </div>
                    <div class="player-money negative" id="slBalanceMoney">HKD -5,194</div>
                </div>
                <div class="payoff-card">
                    <div class="player-info">
                        <div class="player-name">JW</div>
                        <div class="player-imp" id="jwBalanceIMP">-287.5 IMP</div>
                        <div class="recent-change" id="jwRecentChange">
                            <span class="change-label">Last: </span>
                            <span class="change-value">--</span>
                        </div>
                    </div>
                    <div class="player-money positive" id="jwBalanceMoney">HKD 5,486</div>
                </div>
            </div>
            
            <div class="payoff-table-wrapper">
                <div class="payoff-table-title paid-title">üí∞ Â∑≤ÊîØ‰ªò PAID</div>
                <div class="payoff-card">
                    <div class="player-info">
                        <div class="player-name">CHOI</div>
                        <div class="player-imp" id="choiPaidIMP">540 IMP</div>
                    </div>
                    <div class="player-money positive" id="choiPaidMoney">HKD 20,533</div>
                </div>
                <div class="payoff-card">
                    <div class="player-info">
                        <div class="player-name">CHOW</div>
                        <div class="player-imp" id="chowPaidIMP">-540 IMP</div>
                    </div>
                    <div class="player-money negative" id="chowPaidMoney">HKD -20,826</div>
                </div>
                <div class="payoff-card">
                    <div class="player-info">
                        <div class="player-name">SL</div>
                        <div class="player-imp" id="slPaidIMP">287.5 IMP</div>
                    </div>
                    <div class="player-money negative" id="slPaidMoney">HKD -5,194</div>
                </div>
                <div class="payoff-card">
                    <div class="player-info">
                        <div class="player-name">JW</div>
                        <div class="player-imp" id="jwPaidIMP">-287.5 IMP</div>
                    </div>
                    <div class="player-money positive" id="jwPaidMoney">HKD 5,486</div>
                </div>
            </div>
        </div>
        
        <!-- Handicap Settings Section -->
        <div class="section">
            <h2 class="section-title">‚öôÔ∏è ËÆìÂàÜË®≠ÂÆö HANDICAP SETTINGS</h2>
            
            <div class="subsection-title">Section 1: 1V1 Handicap</div>
            <div class="control-group">
                <label>ÂïüÁî® 1V1 ËÆìÂàÜÔºö</label>
                <button onclick="toggle1v1Handicap()" class="secondary-btn" id="handicap1v1Btn">
                    ‚ùå Êú™ÂïüÁî®
                </button>
            </div>
            <div id="handicap1v1Settings" style="display: none;">
                <div class="control-group">
                    <label>ËÆìÂàÜÁé©ÂÆ∂Ôºö</label>
                    <select id="handicap1v1From">
                        <option value="">ÁÑ° None</option>
                        <option value="Choi">Choi</option>
                        <option value="Chow" selected>Chow</option>
                        <option value="SL">SL</option>
                        <option value="JW">JW</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>ËÆìÁµ¶Ôºö</label>
                    <select id="handicap1v1To">
                        <option value="">ÁÑ° None</option>
                        <option value="Choi" selected>Choi</option>
                        <option value="Chow">Chow</option>
                        <option value="SL">SL</option>
                        <option value="JW">JW</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>ËÆìÂàÜ IMPÔºö</label>
                    <input type="number" id="handicap1v1Points" value="2" step="1" min="0">
                </div>
            </div>
            
            <div class="subsection-title">Section 2: 3-Player Handicap</div>
            <div class="control-group">
                <label>Choi ËÆìÂàÜÁµ¶Ôºö</label>
                <button onclick="toggleChoi3PlayerHandicap()" class="secondary-btn" id="choi3PlayerBtn">
                    ‚ùå Êú™ÂïüÁî®
                </button>
            </div>
            <div class="control-group" id="choi3PlayerSettings" style="display: none;">
                <label>Choi ËÆì Chow:</label>
                <input type="number" id="choiToChow" value="2" step="1" min="0" style="width: 100px;">
                <span style="margin: 0 10px;">IMP</span>
                <label>Choi ËÆì JW:</label>
                <input type="number" id="choiToJW" value="2" step="1" min="0" style="width: 100px;">
                <span>IMP</span>
            </div>
            
            <div class="handicap-info">
                ‚úì ËÆìÂàÜË®≠ÂÆöÔºöÊâÄÊúâÊñ∞Ë®òÈåÑÂ∞áÊ†πÊìöË≥ΩÂ±ÄÈ°ûÂûãËá™ÂãïÊáâÁî®Áõ∏ÊáâËÆìÂàÜ
            </div>
        </div>

        <!-- Balance History Chart -->
        <div class="section">
            <h2 class="section-title">üìà È§òÈ°çÊ≠∑Âè≤ÂúñË°® BALANCE HISTORY</h2>
            <div class="chart-container">
                <canvas id="balanceChart"></canvas>
            </div>
        </div>

        <!-- Comparison Chart -->
        <div class="section">
            <h2 class="section-title">üìä Âõõ‰∫∫ÊØîËºÉÂúñ PLAYER COMPARISON</h2>
            <div class="chart-container" style="height: 300px;">
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>
        
        <!-- Records Table Section -->
        <div class="section">
            <h2 class="section-title">üìä Ë≥ΩÂ±ÄË®òÈåÑ GAME RECORDS</h2>
            <div style="overflow-x: auto;">
                <table id="recordTable">
                    <thead>
                        <tr>
                            <th>Êó•Êúü</th>
                            <th>È°ûÂûã</th>
                            <th>Choi<br>ÂéüÂßã/ËÆìÂàÜ/Á∏ΩË®à<br>IMP / $</th>
                            <th>Chow<br>ÂéüÂßã/ËÆìÂàÜ/Á∏ΩË®à<br>IMP / $</th>
                            <th>SL<br>ÂéüÂßã/ËÆìÂàÜ/Á∏ΩË®à<br>IMP / $</th>
                            <th>JW<br>ÂéüÂßã/ËÆìÂàÜ/Á∏ΩË®à<br>IMP / $</th>
                            <th>Ë™øÊï¥</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="recordBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Payment Adjustment Section -->
        <div class="section">
            <h2 class="section-title">üíµ ÊîØ‰ªòË™øÊï¥ PAYMENT ADJUSTMENT</h2>
            <p style="color: #888; margin-bottom: 15px; font-size: 0.9em;">
                Ë™øÊï¥Â∑≤ÊîØ‰ªòÈáëÈ°ç (‰æãÂ¶Ç: Chow ‰ªòÊ¨æÁµ¶ Choi HKD 10,000)
            </p>
            <div class="control-group">
                <label>‰ªòÊ¨æ‰∫∫ FromÔºö</label>
                <select id="payFrom">
                    <option value="Choi">Choi</option>
                    <option value="Chow">Chow</option>
                    <option value="SL">SL</option>
                    <option value="JW">JW</option>
                </select>
            </div>
            <div class="control-group">
                <label>Êî∂Ê¨æ‰∫∫ ToÔºö</label>
                <select id="payTo">
                    <option value="Choi">Choi</option>
                    <option value="Chow">Chow</option>
                    <option value="SL">SL</option>
                    <option value="JW">JW</option>
                </select>
            </div>
            <div class="control-group">
                <label>ÈáëÈ°ç Amount (HKD)Ôºö</label>
                <input type="number" id="payAmount" value="0" min="0" step="100">
            </div>
            <div class="control-group">
                <label>ÂÇôË®ª NoteÔºö</label>
                <textarea id="payNote" placeholder="‰ªòÊ¨æÂéüÂõ†ÊàñÂÇôË®ª"></textarea>
            </div>
            <button onclick="addPaymentAdjustment()" class="primary-btn">üí∞ Ë®òÈåÑÊîØ‰ªò RECORD PAYMENT</button>
        </div>
        
        <!-- Activity Log Section -->
        <div class="activity-log">
            <h2 class="section-title">üìã Ê¥ªÂãïÊó•Ë™å ACTIVITY LOG</h2>
            <div id="activityLog"></div>
        </div>
    </div>
    
    <script>
        // ===========================
        // Firebase Configuration
        // REPLACE WITH YOUR ACTUAL CONFIG!
        // ===========================
        const firebaseConfig = {
              apiKey: "AIzaSyC8xXxXxXxXxXxXxXxXxXxXxXxXxXxXxXx",
  authDomain: "bridge-imp-tracker.firebaseapp.com",
  databaseURL: "https://bridge-imp-tracker-default-rtdb.firebaseio.com",
  projectId: "bridge-imp-tracker",
  storageBucket: "bridge-imp-tracker.appspot.com",
  messagingSenderId: "123456789012",
  appId: "1:123456789012:web:abc123def456ghi789"
};
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let records = [];
        let handicap1v1Enabled = false;
        let choi3PlayerHandicapEnabled = false;
        let balanceChart = null;
        let comparisonChart = null;
        
        const initialPayoff = {
            Choi: { imp: 540, money: 20533 },
            Chow: { imp: -540, money: -20826 },
            SL: { imp: 287.5, money: -5194 },
            JW: { imp: -287.5, money: 5486 }
        };
        
        // Initialize score dropdowns - WHOLE NUMBERS ONLY
        function initializeScoreDropdowns() {
            const dropdowns = ['scoreChoi', 'scoreChow', 'scoreSL', 'scoreJW'];
            dropdowns.forEach(id => {
                const select = document.getElementById(id);
                for (let i = -100; i <= 100; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    if (i === 0) option.selected = true;
                    select.appendChild(option);
                }
                select.addEventListener('change', updateScoreSum);
            });
        }
        
        // Update score sum display
        function updateScoreSum() {
            const sum = parseFloat(document.getElementById('scoreChoi').value || 0) +
                        parseFloat(document.getElementById('scoreChow').value || 0) +
                        parseFloat(document.getElementById('scoreSL').value || 0) +
                        parseFloat(document.getElementById('scoreJW').value || 0);
            
            const sumEl = document.getElementById('scoreSum');
            sumEl.textContent = `Sum: ${sum}`;
            sumEl.className = 'score-sum ' + (sum === 0 ? 'valid' : 'invalid');
            
            document.getElementById('addRecordBtn').disabled = sum !== 0;
        }
        
        // Handle game type change - AUTO-ENABLE 3-PLAYER HANDICAP
        function handleGameTypeChange() {
            const gameType = document.getElementById('gameType').value;
            if (gameType === 'Chow vs JW vs Choi') {
                if (!choi3PlayerHandicapEnabled) {
                    toggleChoi3PlayerHandicap();
                }
            }
        }
        
        // Toggle 1V1 Handicap
        function toggle1v1Handicap() {
            handicap1v1Enabled = !handicap1v1Enabled;
            const btn = document.getElementById('handicap1v1Btn');
            const settings = document.getElementById('handicap1v1Settings');
            
            if (handicap1v1Enabled) {
                btn.textContent = '‚úÖ Â∑≤ÂïüÁî®';
                btn.classList.add('active');
                settings.style.display = 'block';
            } else {
                btn.textContent = '‚ùå Êú™ÂïüÁî®';
                btn.classList.remove('active');
                settings.style.display = 'none';
            }
        }
        
        // Hong Kong time helper
        function formatHongKongTime(timestamp) {
            return new Date(timestamp).toLocaleString('zh-TW', { 
                timeZone: 'Asia/Hong_Kong',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        // Check if record is older than 24 hours
        function isOlderThan24Hours(timestamp) {
            const now = new Date().getTime();
            const recordTime = new Date(timestamp).getTime();
            return (now - recordTime) > (24 * 60 * 60 * 1000);
        }
        
        // Show messages
        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }
        
        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }
        
        // Set today's date
        document.getElementById('gameDate').valueAsDate = new Date();
        
        function toggleChoi3PlayerHandicap() {
            choi3PlayerHandicapEnabled = !choi3PlayerHandicapEnabled;
            const btn = document.getElementById('choi3PlayerBtn');
            const settings = document.getElementById('choi3PlayerSettings');
            
            if (choi3PlayerHandicapEnabled) {
                btn.textContent = '‚úÖ Â∑≤ÂïüÁî®';
                btn.classList.add('active');
                settings.style.display = 'flex';
            } else {
                btn.textContent = '‚ùå Êú™ÂïüÁî®';
                btn.classList.remove('active');
                settings.style.display = 'none';
            }
        }
        
        function addRecord() {
            const date = document.getElementById('gameDate').value;
            const gameType = document.getElementById('gameType').value;
            let scoreChoi = parseFloat(document.getElementById('scoreChoi').value) || 0;
            let scoreChow = parseFloat(document.getElementById('scoreChow').value) || 0;
            let scoreSL = parseFloat(document.getElementById('scoreSL').value) || 0;
            let scoreJW = parseFloat(document.getElementById('scoreJW').value) || 0;
            const adjust = document.getElementById('adjust').value;
            const pointValue = parseFloat(document.getElementById('pointValue').value) || 25;
            
            // Validate zero-sum
            const sum = scoreChoi + scoreChow + scoreSL + scoreJW;
            if (sum !== 0) {
                showError('ÈåØË™§ÔºöÊâÄÊúâÂàÜÊï∏Á∏ΩÂíåÂøÖÈ†àÁÇ∫Èõ∂ÔºÅError: All scores must sum to zero!');
                return;
            }
            
            const originalScores = {
                Choi: scoreChoi,
                Chow: scoreChow,
                SL: scoreSL,
                JW: scoreJW
            };
            
            const handicaps = { Choi: 0, Chow: 0, SL: 0, JW: 0 };
            let handicapInfo = '';
            
            // Apply 1V1 handicap if enabled
            if (gameType === '1V1' && handicap1v1Enabled) {
                const handicapFrom = document.getElementById('handicap1v1From').value;
                const handicapTo = document.getElementById('handicap1v1To').value;
                const handicapPoints = parseFloat(document.getElementById('handicap1v1Points').value) || 0;
                
                if (handicapFrom && handicapTo && handicapPoints > 0) {
                    handicapInfo = `1V1ËÆìÂàÜ: ${handicapFrom} ‚Üí ${handicapTo} ${handicapPoints} IMP`;
                    handicaps[handicapFrom] = -handicapPoints;
                    handicaps[handicapTo] = handicapPoints;
                }
            } 
            // Apply 3-player handicap if enabled
            else if (gameType === 'Chow vs JW vs Choi' && choi3PlayerHandicapEnabled) {
                const choiToChow = parseFloat(document.getElementById('choiToChow').value) || 0;
                const choiToJW = parseFloat(document.getElementById('choiToJW').value) || 0;
                
                if (choiToChow > 0 || choiToJW > 0) {
                    handicapInfo = `3‰∫∫ËÆìÂàÜ: Choi ‚Üí Chow ${choiToChow}, Choi ‚Üí JW ${choiToJW} IMP`;
                    handicaps.Choi = -(choiToChow + choiToJW);
                    handicaps.Chow = choiToChow;
                    handicaps.JW = choiToJW;
                }
            }
            
            scoreChoi += handicaps.Choi;
            scoreChow += handicaps.Chow;
            scoreSL += handicaps.SL;
            scoreJW += handicaps.JW;
            
            const record = {
                timestamp: new Date().getTime(),
                date: date,
                gameType: gameType,
                originalScores: originalScores,
                handicaps: handicaps,
                finalScores: {
                    Choi: scoreChoi,
                    Chow: scoreChow,
                    SL: scoreSL,
                    JW: scoreJW
                },
                adjust: adjust,
                handicap: handicapInfo,
                pointValue: pointValue
            };
            
            // Save to Firebase
            database.ref('records').push(record).then(() => {
                showSuccess('Ë®òÈåÑÂ∑≤ÊàêÂäüÊñ∞Â¢ûÔºÅRecord added successfully!');
                document.getElementById('scoreChoi').value = 0;
                document.getElementById('scoreChow').value = 0;
                document.getElementById('scoreSL').value = 0;
                document.getElementById('scoreJW').value = 0;
                document.getElementById('adjust').value = '';
                updateScoreSum();
            }).catch(error => {
                showError('Êñ∞Â¢ûË®òÈåÑÂ§±ÊïóÔºö' + error.message);
            });
        }
        
        function addPaymentAdjustment() {
            const from = document.getElementById('payFrom').value;
            const to = document.getElementById('payTo').value;
            const amount = parseFloat(document.getElementById('payAmount').value) || 0;
            const note = document.getElementById('payNote').value;
            
            if (from === to) {
                showError('‰ªòÊ¨æ‰∫∫ÂíåÊî∂Ê¨æ‰∫∫‰∏çËÉΩÁõ∏ÂêåÔºÅ');
                return;
            }
            
            if (amount <= 0) {
                showError('ÈáëÈ°çÂøÖÈ†àÂ§ßÊñº0ÔºÅ');
                return;
            }
            
            const impEquivalent = amount / 25;
            
            initialPayoff[from].money -= amount;
            initialPayoff[from].imp -= impEquivalent;
            initialPayoff[to].money += amount;
            initialPayoff[to].imp += impEquivalent;
            
            // Save to Firebase
            database.ref('initialPayoff').set(initialPayoff).then(() => {
                showSuccess('ÊîØ‰ªòË®òÈåÑÂ∑≤ÊàêÂäüÔºÅ');
                document.getElementById('payAmount').value = 0;
                document.getElementById('payNote').value = '';
                
                // Log activity
                const logEntry = {
                    timestamp: new Date().getTime(),
                    message: `üíµ ÊîØ‰ªòË®òÈåÑÔºö${from} ‰ªòÊ¨æÁµ¶ ${to} HKD ${amount.toLocaleString('zh-TW')}${note ? ' - ' + note : ''}`
                };
                database.ref('activityLog').push(logEntry);
            });
        }
        
        function deleteRecord(id) {
            const record = records.find(r => r.id === id);
            if (record && isOlderThan24Hours(record.timestamp)) {
                showError('ÁÑ°Ê≥ïÂà™Èô§Ë∂ÖÈÅé24Â∞èÊôÇÁöÑË®òÈåÑÔºÅCannot delete records older than 24 hours!');
                return;
            }
            
            database.ref('records/' + id).remove().then(() => {
                showSuccess('Ë®òÈåÑÂ∑≤Âà™Èô§ÔºÅ');
                const logEntry = {
                    timestamp: new Date().getTime(),
                    message: `üóëÔ∏è Âà™Èô§Ë®òÈåÑÔºö${record.date} ${record.gameType}`
                };
                database.ref('activityLog').push(logEntry);
            });
        }
        
        function updateTable() {
            const tbody = document.getElementById('recordBody');
            const sortedRecords = [...records].reverse();
            
            tbody.innerHTML = sortedRecords.map(record => {
                const canDelete = !isOlderThan24Hours(record.timestamp);
                const formatPlayerData = (player) => {
                    const orig = record.originalScores[player];
                    const hcap = record.handicaps[player];
                    const final = record.finalScores[player];
                    const origMoney = (orig * record.pointValue).toFixed(0);
                    const hcapMoney = (hcap * record.pointValue).toFixed(0);
                    const finalMoney = (final * record.pointValue).toFixed(0);
                    
                    const hcapSign = hcap >= 0 ? '+' : '';
                    return `
                        <div class="record-detail">Âéü: ${orig} / $${origMoney}</div>
                        <div class="record-detail">ËÆì: ${hcapSign}${hcap} / $${hcapSign}${hcapMoney}</div>
                        <div style="font-weight: 700;">Á∏Ω: ${final} / $${finalMoney}</div>
                    `;
                };
                
                return `
                    <tr>
                        <td>${record.date}</td>
                        <td>${record.gameType}</td>
                        <td>${formatPlayerData('Choi')}</td>
                        <td>${formatPlayerData('Chow')}</td>
                        <td>${formatPlayerData('SL')}</td>
                        <td>${formatPlayerData('JW')}</td>
                        <td>${record.adjust || '-'}</td>
                        <td>
                            <button class="delete-btn" onclick="deleteRecord('${record.id}')" ${canDelete ? '' : 'disabled'}>
                                ${canDelete ? 'Âà™Èô§' : 'üîí'}
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updatePayoff() {
            const totals = {
                Choi: { imp: initialPayoff.Choi.imp, money: initialPayoff.Choi.money },
                Chow: { imp: initialPayoff.Chow.imp, money: initialPayoff.Chow.money },
                SL: { imp: initialPayoff.SL.imp, money: initialPayoff.SL.money },
                JW: { imp: initialPayoff.JW.imp, money: initialPayoff.JW.money }
            };
            
            records.forEach(record => {
                Object.keys(totals).forEach(player => {
                    totals[player].imp += record.finalScores[player];
                    totals[player].money += record.finalScores[player] * record.pointValue;
                });
            });
            
            // Update displays
            Object.keys(initialPayoff).forEach(player => {
                const lowerPlayer = player.toLowerCase();
                document.getElementById(lowerPlayer + 'PaidIMP').textContent = `${initialPayoff[player].imp.toFixed(1)} IMP`;
                document.getElementById(lowerPlayer + 'PaidMoney').textContent = `HKD ${initialPayoff[player].money.toLocaleString('zh-TW')}`;
                document.getElementById(lowerPlayer + 'PaidMoney').className = 'player-money ' + (initialPayoff[player].money >= 0 ? 'positive' : 'negative');
            });
            
            Object.keys(totals).forEach(player => {
                const lowerPlayer = player.toLowerCase();
                document.getElementById(lowerPlayer + 'BalanceIMP').textContent = `${totals[player].imp.toFixed(1)} IMP`;
                document.getElementById(lowerPlayer + 'BalanceMoney').textContent = `HKD ${totals[player].money.toLocaleString('zh-TW')}`;
                document.getElementById(lowerPlayer + 'BalanceMoney').className = 'player-money ' + (totals[player].money >= 0 ? 'positive' : 'negative');
                
                if (records.length > 0) {
                    const lastRecord = records[records.length - 1];
                    const lastChange = lastRecord.finalScores[player];
                    const lastChangeMoney = lastChange * lastRecord.pointValue;
                    const changeSign = lastChange >= 0 ? '+' : '';
                    
                    const now = new Date().getTime();
                    const lastTime = lastRecord.timestamp;
                    const timeDiff = Math.floor((now - lastTime) / 1000 / 60);
                    const timeStr = timeDiff < 1 ? 'just now' : timeDiff < 60 ? `${timeDiff}m ago` : `${Math.floor(timeDiff / 60)}h ago`;
                    
                    document.getElementById(lowerPlayer + 'RecentChange').innerHTML = `
                        <span class="change-label">Last: </span>
                        <span class="change-value">${changeSign}${lastChange} IMP ($${changeSign}${lastChangeMoney.toFixed(0)})</span>
                        <span class="change-label"> ¬∑ ${timeStr}</span>
                    `;
                }
            });
        }
        
        function updateCharts() {
            // Balance History Chart
            const ctx1 = document.getElementById('balanceChart');
            if (!ctx1) return;
            
            const dates = ['Initial'];
            const players = ['Choi', 'Chow', 'SL', 'JW'];
            const colors = {
                Choi: 'rgb(255, 152, 0)',
                Chow: 'rgb(244, 67, 54)',
                SL: 'rgb(76, 175, 80)',
                JW: 'rgb(33, 150, 243)'
            };
            
            records.forEach(r => {
                const dateLabel = r.date + ' ' + new Date(r.timestamp).toLocaleTimeString('zh-TW', { 
                    timeZone: 'Asia/Hong_Kong',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                dates.push(dateLabel);
            });
            
            const datasets = players.map(player => {
                const data = [initialPayoff[player].money];
                let cumulative = initialPayoff[player].money;
                
                records.forEach(record => {
                    cumulative += record.finalScores[player] * record.pointValue;
                    data.push(cumulative);
                });
                
                return {
                    label: player,
                    data: data,
                    borderColor: colors[player],
                    backgroundColor: colors[player] + '40',
                    tension: 0.3,
                    fill: false,
                    borderWidth: 2
                };
            });
            
            if (balanceChart) {
                balanceChart.destroy();
            }
            
            balanceChart = new Chart(ctx1, {
                type: 'line',
                data: { labels: dates, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { 
                            display: true, 
                            text: 'Balance Over Time (HKD)', 
                            color: '#ff9800',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: { 
                            position: 'top', 
                            labels: { color: '#e0e0e0', font: { size: 12 } } 
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: { 
                                color: '#e0e0e0', 
                                callback: function(value) { 
                                    return 'HKD ' + value.toLocaleString(); 
                                } 
                            },
                            grid: { color: '#333' }
                        },
                        x: {
                            ticks: { color: '#e0e0e0', maxRotation: 45, minRotation: 45 },
                            grid: { color: '#333' }
                        }
                    }
                }
            });
            
            // Comparison Chart
            const ctx2 = document.getElementById('comparisonChart');
            if (!ctx2) return;
            
            const totals = {
                Choi: initialPayoff.Choi.money,
                Chow: initialPayoff.Chow.money,
                SL: initialPayoff.SL.money,
                JW: initialPayoff.JW.money
            };
            
            records.forEach(record => {
                Object.keys(totals).forEach(player => {
                    totals[player] += record.finalScores[player] * record.pointValue;
                });
            });
            
            if (comparisonChart) {
                comparisonChart.destroy();
            }
            
            comparisonChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Choi', 'Chow', 'SL', 'JW'],
                    datasets: [{
                        label: 'Current Balance (HKD)',
                        data: [totals.Choi, totals.Chow, totals.SL, totals.JW],
                        backgroundColor: [
                            'rgba(255, 152, 0, 0.7)', 
                            'rgba(244, 67, 54, 0.7)', 
                            'rgba(76, 175, 80, 0.7)', 
                            'rgba(33, 150, 243, 0.7)'
                        ],
                        borderColor: [
                            'rgb(255, 152, 0)', 
                            'rgb(244, 67, 54)', 
                            'rgb(76, 175, 80)', 
                            'rgb(33, 150, 243)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { 
                            display: true, 
                            text: 'Player Comparison', 
                            color: '#ff9800',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: { 
                                color: '#e0e0e0', 
                                callback: function(value) { 
                                    return 'HKD ' + value.toLocaleString(); 
                                } 
                            },
                            grid: { color: '#333' }
                        },
                        x: {
                            ticks: { color: '#e0e0e0' },
                            grid: { color: '#333' }
                        }
                    }
                }
            });
        }
        
        // Listen to Firebase changes
        database.ref('records').on('value', (snapshot) => {
            records = [];
            snapshot.forEach((childSnapshot) => {
                records.push({
                    id: childSnapshot.key,
                    ...childSnapshot.val()
                });
            });
            updateTable();
            updatePayoff();
            updateCharts();
        });
        
        database.ref('initialPayoff').on('value', (snapshot) => {
            if (snapshot.exists()) {
                Object.assign(initialPayoff, snapshot.val());
                updatePayoff();
                updateCharts();
            }
        });
        
        database.ref('activityLog').limitToLast(50).on('value', (snapshot) => {
            const logs = [];
            snapshot.forEach((childSnapshot) => {
                logs.push(childSnapshot.val());
            });
            document.getElementById('activityLog').innerHTML = logs.reverse().map(log => 
                `<div class="log-entry"><span class="log-time">[${formatHongKongTime(log.timestamp)}]</span> ${log.message}</div>`
            ).join('');
        });
        
        // Initialize
        initializeScoreDropdowns();
        updateScoreSum();
    </script>
</body>
</html>
